#ifndef HEADER_at_src_disco_dedup_at_dedup_tile_h
#define HEADER_at_src_disco_dedup_at_dedup_tile_h

/* at_dedup provides services to deduplicate multiple streams of input
   fragments and present them to a mix of reliable and unreliable
   consumers as though they were generated by a single multi-stream
   producer. */

#include "../at_topo.h"

/* TODO: Implement based on TOS requirements - define input kinds */
#define IN_KIND_GOSSIP       (0UL)  /* TODO: Implement based on TOS requirements */
#define IN_KIND_VERIFY       (1UL)
#define IN_KIND_EXECUTED_TXN (2UL)  /* TODO: Implement based on TOS requirements */

/* at_dedup_in_ctx_t is a context object for each in (producer) mcache
   connected to the dedup tile. */

typedef struct {
  at_wksp_t * mem;
  ulong       chunk0;
  ulong       wmark;
  ulong       mtu;
} at_dedup_in_ctx_t;

/* TODO: Implement based on TOS requirements - define MTU constants */
#ifndef AT_TXN_MTU
#define AT_TXN_MTU     (1232UL)  /* TODO: Implement based on TOS requirements */
#endif

#ifndef AT_TXN_RAW_MTU
#define AT_TXN_RAW_MTU (2048UL)  /* TODO: Implement based on TOS requirements */
#endif

/* at_dedup_ctx_t is the context object provided to callbacks from
   at_stem, and contains all state needed to progress the tile. */

typedef struct {
  /* tcache for deduplication */
  ulong   tcache_depth;   /* depth of this dedup's tcache (const) */
  ulong   tcache_map_cnt; /* number of slots to use for tcache map (const) */
  ulong * tcache_sync;    /* local join to the oldest key in the tcache */
  ulong * tcache_ring;
  ulong * tcache_map;

  ulong             in_kind[ 64UL ];
  at_dedup_in_ctx_t in[ 64UL ];

  /* TODO: Implement based on TOS requirements - bundle support */
  int   bundle_failed;
  ulong bundle_id;
  ulong bundle_idx;
  uchar bundle_signatures[ 4UL ][ 64UL ];

  at_wksp_t * out_mem;
  ulong       out_chunk0;
  ulong       out_wmark;
  ulong       out_chunk;

  ulong       hashmap_seed;

  struct {
    ulong bundle_peer_failure_cnt;  /* TODO: Implement based on TOS requirements */
    ulong dedup_fail_cnt;
  } metrics;
} at_dedup_ctx_t;

AT_FN_CONST static inline ulong
at_dedup_scratch_align( void ) {
  return alignof( at_dedup_ctx_t );
}

/* TODO: Implement based on TOS requirements - scratch_footprint
   Needs at_tcache implementation first.

AT_FN_PURE static inline ulong
at_dedup_scratch_footprint( at_topo_tile_t const * tile ) {
  ulong l = AT_LAYOUT_INIT;
  l = AT_LAYOUT_APPEND( l, alignof( at_dedup_ctx_t ), sizeof( at_dedup_ctx_t ) );
  l = AT_LAYOUT_APPEND( l, at_tcache_align(), at_tcache_footprint( tile->dedup.tcache_depth, 0UL ) );
  return AT_LAYOUT_FINI( l, at_dedup_scratch_align() );
}
*/

/* TODO: Implement based on TOS requirements - metrics_write
   Needs TOS metrics system.

static inline void
at_dedup_metrics_write( at_dedup_ctx_t * ctx ) {
  AT_MCNT_SET( DEDUP, TRANSACTION_BUNDLE_PEER_FAILURE, ctx->metrics.bundle_peer_failure_cnt );
  AT_MCNT_SET( DEDUP, TRANSACTION_DEDUP_FAILURE,       ctx->metrics.dedup_fail_cnt );
}
*/

/* TODO: Implement based on TOS requirements - during_frag callback
   This is called between pairs for sequence number checks while reading incoming frags.

static inline void
at_dedup_during_frag( at_dedup_ctx_t * ctx,
                      ulong            in_idx,
                      ulong            seq,
                      ulong            sig,
                      ulong            chunk,
                      ulong            sz,
                      ulong            ctl );
*/

/* TODO: Implement based on TOS requirements - after_frag callback
   This is called after the transaction has been fully received.
   Check if it's a duplicate of a prior transaction.

static inline void
at_dedup_after_frag( at_dedup_ctx_t *    ctx,
                     ulong               in_idx,
                     ulong               seq,
                     ulong               sig,
                     ulong               sz,
                     ulong               tsorig,
                     ulong               tspub,
                     at_stem_context_t * stem );
*/

#endif /* HEADER_at_src_disco_dedup_at_dedup_tile_h */